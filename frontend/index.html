<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flight Reservation Management</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
            secondary: '#1e293b',
            accent: '#f59e42',
          },
        },
      },
    }
  </script>
</head>
<body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-center text-primary flex-1">Flight Reservation Management</h1>
      <!-- Theme Toggle Button: shows the *opposite* mode icon -->
      <button id="themeToggle" aria-label="Toggle dark/light mode" class="ml-4 p-2 rounded-full border border-gray-300 bg-white text-gray-900 dark:bg-gray-700 dark:text-gray-100 dark:border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary transition">
        <span id="themeIcon" class="text-xl">☀️</span>
      </button>
    </div>
    <div class="flex flex-col md:flex-row gap-8">
      <!-- Create Reservation Form -->
      <div class="md:w-1/2 bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Create Reservation</h2>
        <form id="createForm" class="space-y-4">
          <div class="flex gap-4">
            <input type="text" id="companyName" name="companyName" placeholder="Company Name" required class="w-1/2 p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
            <input type="text" id="passengerName" name="passengerName" placeholder="Passenger Name" required class="w-1/2 p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div class="flex gap-4">
            <input type="text" id="flightNumber" name="flightNumber" placeholder="Flight Number" required class="w-1/2 p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
            <input type="number" id="price" name="price" placeholder="Price" min="0" step="0.01" required class="w-1/2 p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div class="flex gap-4">
            <input type="text" id="departureAddress" name="departureAddress" placeholder="Departure Address" required class="w-1/2 p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
            <input type="text" id="destinationAddress" name="destinationAddress" placeholder="Destination Address" required class="w-1/2 p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div class="flex gap-4">
            <input type="datetime-local" id="kickoffTime" name="kickoffTime" required class="w-1/2 p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
            <select id="status" name="status" required class="w-1/2 p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="" disabled selected>Status</option>
              <option value="CONFIRMED">CONFIRMED</option>
              <option value="PENDING">PENDING</option>
              <option value="CANCELLED">CANCELLED</option>
            </select>
          </div>
          <button type="submit" class="w-full py-2 px-4 bg-primary text-white rounded hover:bg-blue-700 transition">Create Reservation</button>
          <div id="createMsg" class="text-center mt-2"></div>
        </form>
      </div>
      <!-- Search Reservations Form -->
      <div class="md:w-1/2 bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Search Reservations</h2>
        <form id="searchForm" class="space-y-4">
          <input type="text" id="searchDeparture" placeholder="Departure Address" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
          <input type="text" id="searchDestination" placeholder="Destination Address" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
          <input type="text" id="searchFlightNumber" placeholder="Flight Number" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
          <select id="searchStatus" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="">Status (Any)</option>
            <option value="CONFIRMED">CONFIRMED</option>
            <option value="PENDING">PENDING</option>
            <option value="CANCELLED">CANCELLED</option>
          </select>
          <input type="datetime-local" id="searchKickoffTime" placeholder="Kickoff Time" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary">
          <div class="flex gap-4">
            <button type="submit" class="flex-1 py-2 px-4 bg-accent text-white rounded hover:bg-orange-600 transition">Search</button>
            <button type="button" id="clearSearch" class="flex-1 py-2 px-4 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-white rounded hover:bg-gray-400 dark:hover:bg-gray-700 transition">Clear Search</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Reservations Table -->
    <div class="mt-10 bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg overflow-x-auto border border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Reservations</h2>
      <div id="loading" class="text-center text-accent mb-2 hidden">Loading...</div>
      <table class="min-w-full table-auto text-sm">
        <thead>
          <tr class="bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
            <th class="px-2 py-2">#</th>
            <th class="px-2 py-2">Company</th>
            <th class="px-2 py-2">Passenger</th>
            <th class="px-2 py-2">Flight #</th>
            <th class="px-2 py-2">Departure</th>
            <th class="px-2 py-2">Destination</th>
            <th class="px-2 py-2">Kickoff</th>
            <th class="px-2 py-2">Price</th>
            <th class="px-2 py-2">Status</th>
            <th class="px-2 py-2"></th>
          </tr>
        </thead>
        <tbody id="reservationsTable" class="bg-white dark:bg-gray-900">
          <!-- Reservations will be inserted here -->
        </tbody>
      </table>
      <div id="noResults" class="text-center text-gray-400 mt-4 hidden">No reservations found.</div>
    </div>
  </div>
  <!-- Custom Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-sm text-center">
      <h3 class="text-lg font-semibold mb-4 text-gray-100">Delete Reservation</h3>
      <p class="mb-6 text-gray-300">Are you sure you want to delete this reservation?</p>
      <div class="flex justify-center gap-4">
        <button id="cancelDeleteBtn" class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 transition">Cancel</button>
        <button id="confirmDeleteBtn" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 transition">Delete</button>
      </div>
    </div>
  </div>
  <!-- Notification area for delete confirmation -->
  <div id="deleteMsg" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded shadow-lg z-50 hidden"></div>
  <!-- Delete Confirmation Alert Modal -->
  <div id="deleteAlertModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-sm text-center border border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Reservation Deleted</h3>
      <p class="mb-6 text-gray-800 dark:text-gray-200">The reservation was successfully deleted.</p>
      <button id="deleteAlertOkBtn" class="px-6 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition">OK</button>
    </div>
  </div>
  <script>
    // API base URL
    const API_BASE = 'http://localhost:8080/tickets';

    // Utility: Format date/time for display
    function formatDateTime(dt) {
      if (!dt) return '';
      return dt.replace('T', ' ').split('.')[0];
    }

    // Show/hide loading indicator
    function setLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }

    // Show message
    function showMessage(el, msg, success = true) {
      el.textContent = msg;
      el.className = success ? 'text-green-400' : 'text-red-400';
      setTimeout(() => { el.textContent = ''; }, 3000);
    }

    // Fetch and display all reservations
    async function fetchReservations() {
      setLoading(true);
      try {
        const res = await fetch(API_BASE);
        const data = await res.json();
        renderTable(data);
      } catch (e) {
        renderTable([]);
      } finally {
        setLoading(false);
      }
    }

    // Render reservations table
    function renderTable(data) {
      const tbody = document.getElementById('reservationsTable');
      const noResults = document.getElementById('noResults');
      tbody.innerHTML = '';
      if (!data || data.length === 0) {
        noResults.classList.remove('hidden');
        return;
      }
      noResults.classList.add('hidden');
      data.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-2 py-1">${i + 1}</td>
          <td class="px-2 py-1">${r.companyName ?? ''}</td>
          <td class="px-2 py-1">${r.passengerName ?? ''}</td>
          <td class="px-2 py-1">${r.flightNumber ?? ''}</td>
          <td class="px-2 py-1">${r.departureAddress ?? ''}</td>
          <td class="px-2 py-1">${r.destinationAddress ?? ''}</td>
          <td class="px-2 py-1">${formatDateTime(r.kickoffTime)}</td>
          <td class="px-2 py-1">${r.price ?? ''}</td>
          <td class="px-2 py-1">${r.status ?? ''}</td>
          <td class="px-2 py-1"><button class='edit-btn bg-accent text-white px-2 py-1 rounded' data-id='${r.id}'>Edit</button> <button class='delete-btn bg-red-600 text-white px-2 py-1 rounded ml-2' data-id='${r.id}'>Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
      // Add edit button listeners
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => startEdit(btn.dataset.id));
      });
      // Add delete button listeners
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteReservation(btn.dataset.id));
      });
    }

    // Edit mode state
    let editId = null;

    // Start editing a reservation
    function startEdit(id) {
      editId = id;
      const row = Array.from(document.querySelectorAll('#reservationsTable tr')).find(tr => tr.querySelector('.edit-btn').dataset.id == id);
      const cells = row.querySelectorAll('td');
      document.getElementById('companyName').value = cells[1].textContent;
      document.getElementById('passengerName').value = cells[2].textContent;
      document.getElementById('flightNumber').value = cells[3].textContent;
      document.getElementById('departureAddress').value = cells[4].textContent;
      document.getElementById('destinationAddress').value = cells[5].textContent;
      document.getElementById('kickoffTime').value = cells[6].textContent ? new Date(cells[6].textContent.replace(' ', 'T')).toISOString().slice(0,16) : '';
      document.getElementById('price').value = cells[7].textContent;
      document.getElementById('status').value = cells[8].textContent;
      document.querySelector('#createForm button[type="submit"]').textContent = 'Update Reservation';
      showCancelEditBtn(true);
    }

    // Show/hide Cancel Edit button
    function showCancelEditBtn(show) {
      let btn = document.getElementById('cancelEditBtn');
      if (!btn && show) {
        btn = document.createElement('button');
        btn.id = 'cancelEditBtn';
        btn.type = 'button';
        btn.className = 'w-full py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700 transition mt-2';
        btn.textContent = 'Cancel Edit';
        btn.onclick = cancelEdit;
        document.getElementById('createForm').appendChild(btn);
      } else if (btn && !show) {
        btn.remove();
      }
    }

    // Cancel edit mode
    function cancelEdit() {
      editId = null;
      document.getElementById('createForm').reset();
      document.querySelector('#createForm button[type="submit"]').textContent = 'Create Reservation';
      showCancelEditBtn(false);
    }

    // Handle create/edit reservation form
    document.getElementById('createForm').addEventListener('submit', async e => {
      e.preventDefault();
      const msg = document.getElementById('createMsg');
      const form = e.target;
      const data = {
        companyName: form.companyName.value,
        passengerName: form.passengerName.value,
        flightNumber: form.flightNumber.value,
        departureAddress: form.departureAddress.value,
        destinationAddress: form.destinationAddress.value,
        kickoffTime: form.kickoffTime.value,
        price: parseFloat(form.price.value),
        status: form.status.value
      };
      try {
        let res;
        if (editId) {
          res = await fetch(`${API_BASE}/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          res = await fetch(API_BASE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        if (!res.ok) throw new Error(editId ? 'Failed to update reservation' : 'Failed to create reservation');
        showMessage(msg, editId ? 'Reservation updated!' : 'Reservation created!', true);
        form.reset();
        cancelEdit();
        fetchReservations();
      } catch (err) {
        showMessage(msg, err.message, false);
      }
    });

    // Handle search form
    document.getElementById('searchForm').addEventListener('submit', async e => {
      e.preventDefault();
      setLoading(true);
      const params = [];
      const dep = document.getElementById('searchDeparture').value;
      const dest = document.getElementById('searchDestination').value;
      const flightNum = document.getElementById('searchFlightNumber').value;
      const status = document.getElementById('searchStatus').value;
      const kickoff = document.getElementById('searchKickoffTime').value;
      if (dep) params.push(`departure=${encodeURIComponent(dep)}`);
      if (dest) params.push(`destination=${encodeURIComponent(dest)}`);
      if (flightNum) params.push(`flightNumber=${encodeURIComponent(flightNum)}`);
      if (status) params.push(`status=${encodeURIComponent(status)}`);
      if (kickoff) params.push(`kickoffTime=${encodeURIComponent(kickoff)}`);
      let url = API_BASE + '/search';
      if (params.length > 0) url += '?' + params.join('&');
      try {
        const res = await fetch(url);
        const data = await res.json();
        renderTable(data);
      } catch (e) {
        renderTable([]);
      } finally {
        setLoading(false);
      }
    });

    // Handle clear search
    document.getElementById('clearSearch').addEventListener('click', e => {
      document.getElementById('searchForm').reset();
      fetchReservations();
    });

    // Custom modal state
    let deleteId = null;
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    // Show custom delete modal
    function showDeleteModal(id) {
      deleteId = id;
      deleteModal.classList.remove('hidden');
    }
    // Hide custom delete modal
    function hideDeleteModal() {
      deleteId = null;
      deleteModal.classList.add('hidden');
    }
    cancelDeleteBtn.onclick = hideDeleteModal;
    confirmDeleteBtn.onclick = async function() {
      if (!deleteId) return;
      setLoading(true);
      try {
        const res = await fetch(`${API_BASE}/${deleteId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete reservation');
        fetchReservations();
        showDeleteAlertModal();
      } catch (err) {
        alert(err.message);
      } finally {
        setLoading(false);
        hideDeleteModal();
      }
    };

    // Show delete alert modal
    function showDeleteAlertModal() {
      document.getElementById('deleteAlertModal').classList.remove('hidden');
    }
    // Hide delete alert modal
    document.getElementById('deleteAlertOkBtn').onclick = function() {
      document.getElementById('deleteAlertModal').classList.add('hidden');
    };

    // --- DARK/LIGHT MODE TOGGLE LOGIC ---
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');

    // Helper: Set theme and update icon
    function setTheme(theme) {
      if (theme === 'light') {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        // Show moon icon (indicates you can switch to dark)
        themeIcon.textContent = '🌙';
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        // Show sun icon (indicates you can switch to light)
        themeIcon.textContent = '☀️';
      }
    }

    // On page load: check localStorage, default to dark
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      setTheme('light');
    } else {
      setTheme('dark');
    }

    // Toggle handler: switch theme and update icon
    themeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.classList.contains('dark');
      setTheme(isDark ? 'light' : 'dark');
    });
    // --- END THEME LOGIC ---

    // Initial fetch
    fetchReservations();
  </script>
</body>
</html> 